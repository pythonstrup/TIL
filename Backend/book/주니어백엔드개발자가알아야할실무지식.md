# 주니어 백엔드 개발자가 알아야 할 실무 지식, 최범균

- 인상적이었던 것. 당장 적용해볼 수 있는 것 위주로 기록

## 2. 느려진 서비스 진단

### 처리량과 응답시간

- 응답 시간 => 처리 시간을 줄여야 함 
  - TTFB(Time to First Byte): 응답 데이터 중 첫 번째 바이트가 도착할 때까지 걸린 시간
  - TTLB(Time to Last Byte): 응답 데이터의 마지막 바이트가 도착할 때까지 걸린 시간
- 처리량 => 동시에 처리할 수 있는 요청 수를 늘려야 함
  - TPS(Transaction Per Second)
  - RPS(Request Per Second)

### 성능 개선 기초

- 병목 지점 판단 => 모니터링 도구 사용해야 한다.
- 수직 확장 vs 수평 확장
- DB 커넥션 풀 크기 조절, DB 커넥션 대기 시간 및 유지 시간
- 서버 캐시 (로컬 vs 리모트)
  - 캐시 스탬피드 문제를 해결하기 위해 캐시를 사전에 적재할 수 있다.
  - 또한 데이터 정합성을 위해 원본이 변경되면 캐시를 무효화하도록 설정 필요. => 리모트 캐시 사용하거나, 로컬 캐시를 사용하되 이벤트 전파를 통해 캐시를 떨궈줘야 함
- 가비지 컬렉터. 상황에 맞는 GC 전략 채택
- 응답 데이터 압축 => gzip으로 압축하면 70% 이상 크기를 줄일 수 있고, 그만큼 전송 시간도 빨라진다.
  - html, css, js, json은 효과적 / 이미지나 zip 파일은 효과 없음
- 정적 자원과 브라우저 캐시 => `Cache-Control` 헤더를 활용
- 정적 자원과 CDN => 요청량 자체가 압도적인 경우 브라우저 캐시가 적용되기 전에 문제 발생 가능성.
  - CDN(Content Delivery Network)을 사용해 오리지 서버가 처리해야 할 트래픽을 상당히 줄일 수 있다.
- 대기 처리 => 트래픽이 폭증하는 경우에는 수용할 수 있는 수준의 트래픽만 받는 방법도 있다.
  - 서버 증설이 필요없다는 장점. 새로고침에 의한 트래픽 폭증 방지.

> #### Accept-Encoding 요청 헤더와 Content-Encoding 응답 헤더
> ```
> Accept-Encoding: gzip, deflate
> ```
> - Accept-Encoding 헤더를 통해 서버에 처리할 수 있는 압축 알고리즘을 알린다.
> - 서버는 Content-Encoding 응답 헤더를 통해 클라이언트에 전달

> #### 트래픽과 비용
> AWS와 같은 클라우드 서비스는 트래픽 양에 비례해 과금 => 데이터 크기를 줄이는 것만으로도 비용 절감


## 3. DB

- 핵심은 인덱스 설정
- 카디널리티 고려.
- 커버링 인덱스
- 비정규화. 미리 집계하기
- 오래된 데이터 삭제 혹은 분리 보관

### 페이지네이션 최적화

- `OFFSET`을 사용하면 그만큼 페이지를 읽어야 해서 오버헤드가 발생한다.
- `id` 값을 기준으로 조회할 수 있다면 아래와 같이 쿼리를 짜볼 수 있다.
  - 마지막으로 조회한 `id` 값을 클라이언트로부터 받아 조회하는 방법이다.

```sql
SELECT * FROM survey
WHERE id > 9836
LIMIT 10
```

### count 조회할 때 집계 테이블을 활용하자.

- 데이터가 늘어날 수록 `count` 쿼리의 속도는 느려진다.
- `count`를 조회하지 않는 방식으로 처리하거나, 집계 테이블을 두고 집계 쿼리를 따로 실행하는 방식을 사용할 수 있다.

### 주의사항

- 쿼리 타임아웃
- 상태 변경 기능은 복제 DB에서 조회 X 
  - 순간적으로 데이터가 일치하지 않을 수 있다.
  - 트랜잭션 문제 발생 가능서도 있다. => Primary에서 트랜잭션이 이뤄지는 동안 복제 DB에서 변경 대상에 대한 불일치 문제 가능성
- 배치 쿼리 실행 시간 증가 문제 => 커버링 인덱스 or 데이터를 일정 크기로 나눠 처리(Spring Batch Chunk 처리)
- 타입이 다른 칼럼 조인 주의 => 타입 변환이 자동으로 발생하여 인덱스를 활용하지 못한다.
- 테이블 변경 신중하게 => 서비스가 장시간 중단되는 상황이 발생할 수 있다.
- DB 최대 연결 개수 관리

### 실패와 트랜잭션

- 트랜잭션 범위를 잘 잡아서 원자성이 필요한 작업에 커밋 및 롤백이 한꺼번에 되도록 구성
- 외부 API 연동 작업이 섞이면 트랜잭션 처리 복잡
  - 외부 API는 성공했는데 DB 트랜잭션 실패하면 어떻게 처리할 것인가? 
