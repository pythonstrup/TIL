# 12장 클라이언트 관리

- 클라이언트 연결의 성능을 향상시키기 위한 파이프라이닝과 클라이언트 사이드 캐싱

## 클라이언트 핸들링

- 레디스는 클라이언트 연결을 수락하는 데 TCP 포트와 유닉스 소켓을 사용할 수 있다.
  - 일반적으로 사용자 연결을 받기 위해 TCP 포트를 사용하지만, 설정 파일에서 `unixsocket` 및 `unixsocketperm` 매개변수를 설정하면 원하는 경로에서 소켓 파일을 생성하고 해당 파일의 권한을 지정할 수 있다.

```
unixsocket /tmp/redis.sock
unixsocketperm 777
```

- 이렇게 설정한 뒤 레디스를 시작하면 원하는 경로에 파일이 생성되며, 소켓 통신이 활성화된다.
  - 이후에는 클라이언트가 해당 유닉스 소켓 파일의 경로를 사용해 레디스 서버에 연결할 수 있다.

```shell
$ redis-cli -s /tmp/redis.sock
```

- 레디스는 `멀티플렉싱 Multiplexing` 방식을 사용하며, 이로 인해 하나의 통신 채널을 통해 여러 데이터 스트림을 전송할 수 있다.
  - 하나의 스레드에서 여러 소켓을 감시하고, 소켓 이벤트가 발생하는지 지속적으로 확인할 수 있기 때문에 효율적인 다중 클라이언트 지원을 가능하게 한다.
  - 또한, 많은 클라이언트 요청을 동시에 처리하는 데 블로킹 문제를 피할 수 있다.
- 또한 Non-Blocking을 활용해 I/O 작업 완료될 때까지 대기하지 않고 다른 작업을 처리할 수 있어서, 클라이언트 요청을 비동기적으로 처리하고 다수의 클라이언트 요청을 동시에 처리할 수 있다.
- 레디스는 클라이언트 커넥션을 생성할 때 `TCP_NODELAY` 옵션을 사용
  - 작은 데이터라도 버퍼링하지 않고 지연 없이 가능한 한 빨리 패킷으로 전송하려 시도.
  - 이는 주로 작은 데이터 조각을 실시간으로 전송해야 하는 경우에 사용. => 클라이언트의 연결 지연을 최소화

> #### 참고
> - 버전 7을 기준으로, 레디스와 클라이언트가 통신할 때 `TCP_NODELAY` 옵션을 해제할 수는 없다.
> - 하지만 레디스 노드 간 복제 연결을 할 때 에는 다음 설정 값을 변경해 TCP_NODELAY 옵션을 해제할 수 있다.
> ```
> repl-disable-tcp-nodelay yes
> ```
> - `yes`로 설정하면 복제본에 데이터를 전송할 때 더 작은 수의 TCP 패킷과 대역폭을 사용 => 40ms까지의 지연이 발생할 수 있다.
> - `no`로 하면 마스터와 복제본 간 데이터 지연을 최소화해서 데이터를 복제본에서 좀 더 빨리 확인할 수 있지만, 데이터 복제를 위해 더 많은 대역폭 사용
> - 레디스는 지연 시간을 최소화하기 위해 `no`로 설정하고 있지만, 대규모 트래픽 상황 또는 마스터와 복제본 간의 거리가 멀 경우에는 `yes`로 변경하는 것이 도움이 될 수 있다.

- 클라이언트가 초기화되면 `maxclients` 설정값과 비교해 현재의 클라이언트 수가 `maxclients` 값에 도달했는지 확인.
  - 이 값을 초과하면 새로운 클라이언트의 접속을 거부
- 레디스 버전 2.6 이후 버전부터는 기본적으로 `maxclients` 수가 10000으로 설정되며, 설정 파일에서 별도로 변경하지 않는 한 이 값이 유지
  - 그러나 레디스가 시작될 때 운영체제의 설정 값을 확인해 클라이언트의 수를 제한할 수 있다.
  - 레디스 서버 내부적으로 32개의 파일 디스크립터 수를 사용한다고 예약했기 때문에 설정한 `maxclients` 값은 운영체제에 맞게 변경돼 레디스 인스턴스가 시작된다.

### 클라이언트 버퍼 제한

#### 출력 버퍼

- 레디스는 클라이언트에 반환할 데이터를 임시로 저장하기 위해 각 클라이언트마다 `클라이언트 출력 버퍼 client output buffer`를 생성한다.
  - 연결된 클라이언트가 1,000개라면 1,000개의 출력 버퍼를 생성한다.
  - 만약 출력 버퍼의 크기는 가변적이라면 무제한으로 늘어날 수 있음.
- 특히 pub/sub 클라이언트에서 발행자가 메시지를 발행하면 해당 메시지는 모든 구독자에게 전달
  - 일반적으로 pub/sub 연결의 경우 발행자가 보낸 새로운 메시지를 구독자가 처리하는 속도가 충분하지 않은 상황에서 발생하는 경우가 많다.
- 따라서 레디스는 출력 버퍼 크기에 대한 제한을 둬서, 버퍼 크기가 일정 수준 이상으로 증가할 경우 클라이언트 연결을 종료하게 된다.
- 두 가지 종류의 제한값을 사용할 수 있다.
1. 하드 제한: 고정된 제한값. 도달하면 레디스는 클라이언트 연결을 가능한 한 빨리 닫는다.
2. 소프트 제한: 시간에 따라 다르며, 이를테면 10초 동안 지속적으로 32MB보다 큰 출력 버퍼를 유지한 경우 연결을 닫는다.

- pub/sub 클라이언트의 경우 기본 하드 제한이 32MB, 소프트 제한은 60초당 8MB
  - pub/sub 클라이언트가 빠르게 처리되는 메시지들을 처리하기 위해 더 많은 메모리 공간이 필요하기 때문
- 복제본을 위한 출력 버퍼 크기 제한은 기본이 하드 제한은 256MB, 소프트 제한은 60초당 64MB
  - 복제본이 마스터 서버로부터 대량의 데이터를 받아들이는 경우가 많아, 더 큰 출력 버퍼가 필요하기 때문
- `CONFIG SET`을 통해 변경 가능.

```redis
> CONFIG SET client-output-buffer-limit <class> <hard-limit> <soft-limit> <soft-limit-duration>
```

- `class`: `normal`, `slave(replica)`, `pubsub` 중 하나
  - `normal`: 일반 레디스 클라이언트
  - `salve(replica)`: 복제본 클라이언트
- `hard-limit` & `soft-limit`: 하드 제한 및 소프트 제한 값. 바이트 단위로 지정
- `soft-limit-duration`: 소프트 제한이 적용되는 시간 간격. 초 단위

- 아래 명령어는 모든 limit 값을 제거하는 예시

```redis
> CONFIG SET client-output-buffer-limit "slave 0 0 0"
OK
```

#### 클라이언트 쿼리 버퍼 (내부 버퍼)

- 클라이언트에서 받은 커맨드를 레디스에서 잠시 보관하는 내부 버퍼의 역할.
- 기본적으로 1GB로 설정
  - 클라이언트에서 발생하는 버그로 인해 클라이언트 쿼리 버퍼가 무한히 증가하는 것을 방지하기 위한 조치
- 특별한 상황에서 조정이 필요하다면 `client-query-buffer-limit` 설정을 변경

### 클라이언트 이빅션

- 클라이언트 연결 수 증가 => 메모리 사용량 증가 => 메모리 과다 사용으로 인한 OOM 및 데이터 이빅션 유발
  - `maxmemory-policy` 설정을 한차례 확인한 적이 있음
- 레디스 7.0부터는 `maxmemory-clients` 설정값을 사용해 모든 클라이언트 연결이 사용하는 누적 메모리의 양을 제한할 수 있게 되었다.
  - 임계치에 도달하면 레디스는 서버에서 클라이언트 연결을 해제해 메모리를 확보한다.
  - 서버는 가장 많은 메모리를 사용하는 연결부터 해제하려고 시도하며, 이 기능을 `클라이언트 이빅션 client eviction`이라고 한다.
- `redis.conf`나 `CONFIG SET`으로 변경 가능
- 이 값을 0으로 지정하면 기능을 사용하지 않음을 의미
- 퍼센트 기호를 사용해 `maxmemory`의 비율로 설정하는 것도 가능하다.

```
maxmemory-clients 1G
maxmemory-clients 10%
```

- 대규모 트래픽 환경에서는 5%나 10%로 설정하는 것을 권장한다.
- 복제 연결에 사용되는 복제본과 마스터 커넥션은 클라이언트 이빅션 기능에 영향을 받지 않기 때문에 복제 과정에서 사용하는 메모리 양이 매우 많더라도 이 설정에 의해 복제 연결은 자동으로 끊어지지 않는다.
- 특정 클라이언트만 기능에서 제외하는 것도 가능하다.
- 아래 명령어를 사용하면 강제로 연결이 끊기 지 않으며 `off`로 바꿔줘야 이전 상태로 복원 가능하다.

```redis
> CLIENT NO_EVICT on
```

---

# 참고자료

- 개발자를 위한 레디스, 김가람 지음

