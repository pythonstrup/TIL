# 11장 복제와 일관성

- 합의 알고리즘과 원자적 커밋 알고리즘
  - 이들을 심층적으로 이해하려면 `일관성 모델 consistency model`에 대해 알아야 한다.
  - 여러 개의 데이터 복제본을 유지하는 일관성 모델은 시스템의 상태와 작동 방식을 정의하는 중요한 개념
- `내결함성 fault tolerance`: 장애가 발생해도 정상적으로 작동할 수 있는 시스템을 나타내는 속성
  - 1차적 목표. `단일 장애점 single point of failure`을 제거하고 필수 컴포넌트를 이중화
  - 일반적으로 이중화는 사용자에게 완전히 투명
- 시스템에 여러 개의 데이터 복제본을 저장하면 일부 서버에 장애가 발생해도 다른 서버가 `장애 조치 failover`를 수행해 시스템이 정상적으로 작동 가능
  - `진실 공급원 source of truth`이 하나인 시스템(예를 들어 primary-replication 노드 구조의 데이터베이스)은 `복제 서버 replica`를 새로운 마스터로 승격시켜 장애를 직접 처리
  - 그에 반해 다른 구조의 시스템은 직접적으로 구조를 변경 X, 대신 읽기와 쓰기 요청 시 여러 노드의 응답을 수집해 데이터의 일관성 유지
- `replication`에서 여러 복제본을 원자적으로 업데이트하는 작업은 합의 알고리즘과 유사. 모든 요청마다 수행하기엔 비용이 높다.
  - 따라서 노드 간에 어느 정도 상태 차이는 허용하면서 사용자에게 최대한 일관된 데이터를 제공할 수 있는 비용 효율적이고 유연한 알고리즘 필요
- 멀티 데이터센터 배포 구조에서 데이터 복제는 더 중요.
  - `지리적 이중화 geo-replication`를 통해 데이터 가용성을 높이고 데이터센터 장애를 대응
  - 복제본을 사용자와 물리적으로 가까운 곳에 저장해 전송 레이턴시를 줄일 수 있다.
- 데이터 레코드 수정 -> 복제본 업데이트
  - 가장 중요한 작업은 3가지. (1) 쓰기 (2) `복제본 갱신 replica update` (3) 읽기
  - 클라이언트가 이러한 작업을 요청하면 일련의 이벤트가 발동. 복제본 갱신은 클라이언트 관점에서 쓰기가 완료된 후 수행되기도 한다.
  - 하지만 갱신 시기와 상관없이 클라이언트가 의도한 순서대로 작업이 수행돼야 한다.

---

## 고가용성 high-availability

- 간헐적 장애가 가용성에 영향을 주지 않아야 한다.
  - 사용자 관점에서 시스템은 아무 문제도 발생하지 않은 것처럼 계속 작동해야 한다.
- 시스템 가용성은 매우 중요한 속성.
  - 소프트웨어 공학에서는 항상 가용성을 높이고 다운타임을 최소화하려고 애쓴다.
  - 시스템 업타임은 엔지니어링 팀의 큰 자랑거리
- 낮은 가용성 => 고객 이탈 또는 매출 하락
- 고가용 시스템은 일부 노드의 장애 및 오류를 단계적으로 대응할 수 있어야 한다.
  - 이중화와 복제를 통해 해결
  - 이중화 => 여러 복제본 동기화 문제. 복구 메커니즘 추가 필요

---

## CAP 이론

- 시스템이 모든 요청에 대해 성공적으로 응답할 수 있는 능력을 나타내는 속성.
  - 가용성 = 이론적으로 `결과적 응답 eventual response`을 의미하지만 현실적으로 응답이 지나치게 오래 걸리는 서비스는 바람직하지 않다.
- 이상적으로 모든 작업은 일관성을 유지해야 한다.
  - 일관성이란 원자적 또는 `선형화할 수 있는 linearizable` 일관성을 의미
  - 선형화 가능한 이력(히스토리)이란 원래의 실행 순서가 보존되는 일련의 짧은 작업들로 나타낼 수 있다.
  - 선형화 가능성은 시스템 상태에 대한 추론을 단순화하고 분산 시스템이 단일 서버에서 실행되는 것처럼 보이게 한다.
- 네트워크 파티션이 발생해도 일관성과 가용성을 모두 충족하는 시스템을 구축하는 방법이 필요하다.
  - 네트워크는 여러 부분으로 분할될 수 있고 이로 인해 프로세스는 서로 통신이 불가능할 수 있다.
  - 이 경우 파티션된 노드 사이의 메시지는 제대로 전달되지 않는다.
- 가용성은 모든 정상 노드는 결과를 반환한다는 것을 의미하고 일관성은 모든 결과는 선형화할 수 있다는 것을 의미한다.
  - 에릭 브루어가 공식화한 CAP 이론은 `일관성 Consistency`과 `가용성 Availability`, `분할 내성 Partition tolerance` 사이의 트레이드-오프를 설명
- 비동기 시스템에서는 가용성을 보장 X
  - 나아가 네트워크 파티션이 발생했을 때 가용성과 일관성을 동시에 보장하는 시스템은 구현이 불가능
  - 대신 최선의 가용성과 높은 일관성 vs 최선의 일관성과 높은 가용성을 보장하는 시스템

> #### 높은 일관성과 분할 허용 CP
> - 요청을 정상적으로 처리하는 것보다 일관된 데이터를 제공하는 것을 더 중요시
> - 파티션이 발생하면 요청을 실패시킨다는 의미다.

> #### 가용성 보장 및 파티션 허용 AP
> - AP 시스템은 일관성을 일부 포기하고 일관되지 않은 데이터를 제공

- CP 시스템
  - ex) 과반수 노드가 동의해야 하는 합의 알고리즘: 데이터의 일관성 보장 but, 파티션 발생 시 정상 작동하지 않을 수 있다.
- AP 시스템
  - 단 하나의 복제 서버라도 살아 있다면 모든 쓰기와 읽기를 허용
  - 이 경우 데이터가 손실되거나 일관되지 않을 수 있다.
- `PACELEC 정리`는 CAP 이론을 확장한 개념으로 네트워크 파티션 발생 시 가용성과 일관성 중 하나를 선택해야 하고, 나아가 시스템이 정상적으로 작동하더라도 레이턴시와 일관성 중 하나를 선택해야 한다고 주장한다.

### CAP 이론의 특성

- CAP는 노드 충돌 또는 다른 종류의 장애보다 네트워크 파티션만을 다룬다.
  - 클러스터에서 분할된 노드는 일관되지 않은 요청을 처리할 수 있지만 장애가 발생한 노드는 응답조차 하지 않는다.
  - 일관성 문제는 노드에 장애가 발생했을 때만 생기는 것이 아니라는 의미이기도 하다.
  - 실제 운영 중에는 다양한 종류의 장애 시나리오가 존재한다. (일부는 네트워크 파티션으로 인한 장애)
- CAP 이론에 의하면 모든 노드가 정상적으로 가동 중이어도 노드 간에 연결 문제가 있으면 일관성 문제가 발생할 수 있다.
  - 장애가 발생한 노드 수와 무관하게 모든 정상 노드는 올바로 응답할 것이라고 예상하기 때문이다.

> #### cf) CAP 이론의 일관성과 ACID의 일관성은 의미가 상당히 다르다.
> - ACID의 일관성은 트랜잭션의 일관성을 의미한다. 트랜잭션은 데이터베이스의 제약 조건(고유성 제약 조건, 참조 무결성 등)을 위반하지 않고 상태를 유효한 상태에서 또 다른 유효한 상태로 변경한다.
> - 그에 반해 CAP의 일관성은 연산의 원자성(작업 전체가 성공하거나 실패한다)과 일관성(어떤 작업도 데이터를 일관되지 않은 상태로 방치하지 않는다)을 의미한다.

- CAP 이론의 가용성도 앞에서 설명한 고가용성과 같지 않다.
  - CAP 이론은 레이턴시를 제한하지 않는다.
  - 나아가 CAP와는 다르게 일반적인 의미의 데이터베이스 가용성은 모든 정상 노드가 모든 요청에 응답할 것이라고 가정하지 않는다.
- CAP는 모든 경우를 설명하지는 않는다. (CAP는 이분법적이라는 생각이 든다.)

### 수확률과 산출률

- CAP 이론은 일관성과 가용성을 가장 엄격한 맥락에서 선형화 가능성과 시스템이 모든 요청에 결국 응답하는 능력으로만 보고 논의한다.
  - 이 때문에 두 속성 사이에서 어려운 선택을 해야 한다.
  - 하지만 두 속성을 더 완화하는 편이 더 나은 애플리케이션도 있기 때문에 이러한 성질들을 좀 더 약한 형태로도 생각해볼 만하다.
- 일관성과 가용성 중 하나를 선택하기보다는 일부 제약 조건을 완화할 수도 있다.
  - 똑같은 결과가 보장되는 두 가지 조정 가능한 수치인 `수확률 harvest`과 `산출률 yield`을 사용한다.

> #### 수확률
> - 쿼리 결과의 완전성
> - ex) 실제 쿼리 결과의 로우 수 100개, 일부 노드의 장애로 인해 99개만 반환되더라도 쿼리가 실패하고 아무것도 반환되지 않는 것보다는 더 나을 수 있다.

> #### 산출률
> - 전체 요청 중 성공적으로 완료된 요청 수를 나타낸다.
> - 산출률과 업타임은 같지 않다. 부하가 높은 노드는 살아 있더라도 일부 요청에 응답하지 못할 수 있다.

- 이러한 척도를 도입하면 두 속성 사이의 트레이드-오프를 따지는 관전이 절대 비교에서 상대 비교로 바뀐다.
  - 수확률보다 산출률이 더 높은 경우 더 많은 요청 처리 가능. but, 반환된 데이터가 불완전할 수 있음.
  - 사용 가능한 파티션에서만 쿼리 결과를 반환하면 산출률을 높일 수 있다.
  - ex) 일부 사용자 정보가 저장된 노드가 중단돼도 그 외의 사용자에 대한 요청은 계속해서 처리할 수 있다. 
  - ex2) 또는 애플리케이션 내 중요한 데이터는 반드시 완전한 형태로 반환해야 하지만 그 외의 데이터는 어느 정도의 불일치를 허용할 수 있다.

---

## 공유 메모리


