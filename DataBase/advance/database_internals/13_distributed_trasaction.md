# 13장 분산 트랜잭션

- 분산 시스템에서의 순서 유지 => 어느 정도의 일관성 필요
  - 여러 작업을 원자적으로 수행 필요
- 핵심: 가능한 이력을 선택하고 교차수행 시나리오르르 모델링 및 정의
  - 이력 = 의존성 그래프
- 트랜잭션 = 여러 작업의 집합이자 원자적 단위.
  - 원자성 보장을 위해 복구가 가능해야 한다.
- 네트워크 파티션과 노드 장애 복구도 가능해야 한다.

## 원자적 연산처럼 수행하기

- `원자적 커밋 atomic commitment` 알고리즘
  - 참가 노드 사이의 의견 불일치를 허용하지 않는 것.
  - 비잔틴 장애가 발생할 수 있는 시스템에서는 사용 불가
- 원자적 커밋의 목적? 트랜잭션 수행 여부에 대한 합의 도출!
- DB 개발자는 다음 사항을 생각해야 한다.
1. 커밋은 포인터가 가리키는 위치를 변경해 새로운 데이터에 대한 접근을 허용하는 간단한 작업
2. 커밋된 트랜잭션의 결과를 어떻게 최대한 빠르게 접근 가능한 상태로 만들 것인가?
3. 실패한 트랜잭션을 어떻게 만들 것인가?

---

## Two-Phase Commit

- 다중 파티션 원자적 업데이트를 허용하는 가장 단순한 분산 커밋 프로토콜
- (2단계 커밋이라는 이름 그대로) 이 알고리즘은 2단계로 구성
1. 결과를 전파하고 의견을 수렴
2. 각 노드는 단순히 1단계의 결과를 접근 가능한 상태로 전환

- 합의 과정의 기준점이 되는 노드: `리더` 또는 `코디네이터` 
- 나머지 노드: `코호트 cohort`
  - 일반적으로 트랜잭션에서 접근하는 데이터가 저장된 서로 겹치지 않는 파티션
  - 다른 충돌하는 트랜잭션이 이미 값을 변경했다면 코호트는 코디네이터의 제안을 거부할 수 있다. (Abort)
- 장애를 복구할 수 있도록 모든 단계마다 결과를 영구적으로 저장해야 한다.

### 2PC의 코호트 장애 처리

- 장애 발생(합의 불가) = 트랜잭션 실패
  - `스패너 Spanner`는 2PC를 개별 노드가 아닌 팍소스 그룹 단위로 실행해 프로토콜의 가용성 개선
- 2PC 알고리즘은 수락한 제안을 철회할 수 없으며 오직 코디네이터만이 트랜잭션을 중단시킬 수 있다는 전제를 기반
- 준비 단계에서 코호트가 응답하지 않으면 코디네이터는 타임아웃을 트리거하거나 트랜잭션을 중단해야 한다.

### 2PC의 코디네이터 장애 처리

- 코호트가 코디네이터로부터 커밋 또는 중단 요청을 전달받지 못한 경우 직접 결과를 확인해야 한다.
- 2PC의 핵심. 모든 코호트에서 커밋하거나. 아예 커밋하지 않거나.
- 코디네이터가 트랜잭션을 커밋 또는 중단할 수 없는 경우 클러스터는 미확정 상태에 이름.
  - 코디네이터 장애 => 코호트 수렴 결과를 알 수 없음.
  - Blocking Atomic Commit Algorithm
- MySQL과 PostgreSQL, MongoDB 등이 2PC를 사용

---

## Three-Phase Commit

- 코디네이터 장애 발생 시 코호트가 시스템 상태에 따라 직접 커밋 또는 중단을 결정
- 3PC는 요청을 동기적으로 처리하며 통신 장애는 발생할 수 없다고 가정
- 2PC와 3PC
  - 공통점: 반든시 코디네이터가 존재해야 한다.
  - 차이점: 3PC는 코호트에 타임아웃을 설정한다.
- 단계
1. 제안: 코디네이터는 코호트에 제안 값을 전달하고 의견을 수집
2. 준비: 코디네이터가 코호트에 수렴 결과를 알린다. 모두 커밋에 동의한 경우 `Prepare` 메시지를 보내 커밋을 준비하도록 지시. 반대의 경우는 `Abort` 메시지를 보낸다.
3. 커밋: 코디네이터는 코호트에게 트랜잭션 커밋을 지시

### 3PC의 코디네이터 장애 처리

- 모든 코호트가 현재 단계를 완료하기 전까지 다음 단계로 넘어갈 수 없다.
- 코디네이터가 일정 시간 내에 코호트에 메시지를 보내지 않으면 코호트는 트랜잭션을 중단할 수 있다.
- 3PC에서 최악의 상황은 네트워크 파티션이 발생하는 경우다.
  - 성공적으로 준비 상태로 전환한 일부 코호트가 시간 초과 후 커밋을 하기 때문이다. => Split Brain 문제
- 3PC는 2PC의 블로킹 문제를 해결할 수 있지만 메시지 오버헤드가 더 크고, 일관성 보장 X.
- 따라서 많이 사용되지 않는다.
