# 06 응용 서비스와 표현 영역

## 1. 표현 영역과 응용 영역

- 도메인이 제 기능을 하려면 사용자와 도메인을 연결해 주는 매개체가 필요하다.
- 표현 영역은 사용자의 요청을 해석한다.
  - 요청 파라미터를 포함한 HTTP 요청이 표현 영역에 전달되면, 표현 영역은 URL, 요청 파라미터, 쿠키, 헤더 등을 이용해서 사용하자 실행하고 싶은 기능을 판별하고 그 기능을 제공하는 응용 서비스를 실행한다.
- 실제 사용자가 원하는 기능을 제공하는 것은 응용 영역에 위치한 서비스다.

----

## 2. 응용 서비스의 역할

- 사용자의 요청을 처리하기 위해 레포지토리에서 도메인 객체를 가져와 사용한다.
- 표현 영역 입장에서 봤을 땐 응용 서비스는 도메인 영역과 표현 영역을 연결해 주는 창구 역할을 한다.
- 응용 서비스가 복잡하다면 응용 서비스에서 도메인 로직 일부를 구현하고 있을 가능성이 높다.
  - 코드 중복, 로직 분산 등 코드 품질에 안 좋은 영향을 줄 수 있다.
- 응용 서비스는 트랜잭션 처리도 담당한다. 응용 서비스는 도메인의 상태 변경을 트랜잭션으로 처리해야 한다.
  - 데이터 일관성을 위해!

### 2-1. 도메인 로직 넣지 않기

- 도메인 로직이 응용 서비스에 분산되어 있을 때의 문제
1. 코드의 응집성이 떨어진다. 도메인 로직을 파악하기 위해 여러 영역을 분석해야 한다.
2. 여러 응용 서비스에서 동일한 도메인 로직을 구현할 가능성이 높아진다. (코드 중복)
- 이와 같은 문제는 코드 변경을 어렵게 만든다.

----

## 3. 응용 서비스의 구현

### 3-1. 응용 서비스의 크기

- 응용 서비스는 보통 다음의 두 가지 방법 중 한 가지 방식으로 구현한다.

1. 한 응용 서비스 클래스에 회원 도메인의 모든 기능 구현하기
2. 구분되는 기능별로 응용 서비스 클래스 따로 구현하기

- 구분되는 기능별로 서비스 클래스를 구현하는 방식은 한 응용 서비스 클래스에서 한 개 내지 2~3개의 기능을 구현.
  - 클래스 개수는 많아지지만, 코드 품질을 일정 수준으로 유지하는 데 도움이 된다.
  - 필요한 의존 객체만 포함하기 때문에 다른 코드의 영향을 받을 가능성도 적다.

### 3-2. 응용 서비스의 인터페이스와 클래스

- 인터페이스가 필요한 상황
1. 구현 클래스가 여러 개인 경우 (런타임에 구현 객체를 교체해야 할 경우) => 보통 응용 서비스는 런타임에 교체하지 않는다.
2. 표현 영역의 단위 테스트 testability를 보장하기 위해. => 굳이? mock을 사용할 수 있기 때문에 꼭 필요하진 않다.

### 3-3. 메소드 파라미터와 값 리턴

- 개별 파라미터 vs 레코드
- 요청 파라미터가 2개 이상이라면 레코드로 묶는 것이 좋다.
- 응용 서비스에서 애그리거트 자체를 리턴하면 코딩은 편할 수 있지만 도메인의 로직 실행을 응용 서비스와 표현 영역 두 곳에서 할 수 있게 된다.
  - 응집도가 낮아진다.
  - 따라서 필요한 데이터만 리턴하는 것이 기능 실행 로직의 응집도를 높이는 확실한 방법이다.

### 3-4. 표현 영역에 의존하지 않기

- 응용 서비스의 파라미터 타입을 결정할 때 주의할 점. 표현 영역과 관련된 타입을 사용하면 안 된다.
  - ex) `HttpServletRequest`, `HttpServletResponse`, `HttpSession`
- 응용 서비스에서 표현 영역에 대한 의존이 발생하면 응용 서비스 단독으로 테스트하기가 어려워진다.
  - 게다가 표현 영역의 구현이 변경되면 응용 서비스의 구현도 함께 변경해야 하는 문제도 발생한다.
- 더 심각한 것은 응용 서비스가 표현 영역의 역할까지 대신하는 상황이 벌어질 수도 있다는 것이다.
  - 표현 영역의 응집도가 깨지고, 결과적으로 코드의 유지 보수 비용을 증가시킨다.

### 3-5. 트랜잭션 처리

- 트랜잭션을 관리하는 것은 응용 서비스의 중요한 역할이다.
- 스프링의 `@Transaction` 어노테이션을 사용.

----

## 4. 표현 영역

- 표현 영역의 책임은 아래와 같다.
1. 사용자가 시스템을 사용할 수 있는 흐름(화면)을 제공하고 제어한다.
2. 사용자의 요청을 알맞은 응용 서비스에 전달하고 결과를 사용자에게 제공한다.
3. 사용자의 세션을 관리한다.

- 세션 관리는 권한 검사와도 연결되는데, 뒤에서 다룸.

----

## 5. 값 검증

- 표현 영역과 응용 서비스 두 곳에서 모두 수행할 수 있다.
- 원칙적으로 모든 값에 대한 검증은 응용 서비스에서 처리한다.
  - ex) 회원 가입을 처리할 때 파라미터로 전달받은 값이 올바른지 검사
- 표현 영역은 잘못된 값이 존재하면 이를 사용자에게 알려주고 값을 다시 입력받아야 한다. => 에러를 묶어서 던지기도 한다.
- 아래와 같이 역할을 나누어 검증을 수행할 수도 있다.
- 표현 영역: 필수 값, 값의 형식, 범위 등을 검증
- 응용 서비스: 데이터의 존재 유무와 같은 논리적 오류를 검증
  - 필자는 응용 서비스에서 필수 값 검증을 하는 편이라고 함. => 완성도를 위해.

----

## 6. 권한 검사

- 개발하는 시스템마다 권한의 복잡도가 다르다.
- 보통 다음 세 곳에서 권한 검사를 수행할 수 있다.
1. 표현 영역: 인증된 사용자인지 검사, URL별 권한 검사.
2. 응용 서비스: 메소드 단위 권한 검사(AOP를 활용할 수 있음).
3. 도메인: 구현이 복잡하다.

----

## 7. 조회 전용 기능과 응용 서비스

- 단일 쿼리? 컨트롤러에서 바로 조회할 수도 있다.

----

# 참고자료

- 도메인 주도 개발 시작하기, 최범균 지음

