# 07 도메인 서비스

## 1. 여러 애그리거트가 필요한 기능

- 한 애그리거트로 기능을 구현할 수 없을 때가 있다.
- ex) 결제 금액 계산 로직
  - 상품: 구매하는 상품의 가격이 필요. 또한 상품에 따라 배송비가 추가되기도 한다.
  - 주문: 상품별로 구매 개수가 필요
  - 할인 쿠폰: 쿠폰별로 지정한 할인 금액이나 비율에 따라 주문 총 금액을 할인. 조건에 따라 중복 사용 및 적용 가능 제약 조건 등 할인 계산이 복잡해진다.
  - 회원: 회원 등급에 따라 추가 할인이 가능
- 하나의 애그리거트에 넣기 애매한 도메인 기능을 억지로 특정 애그리거트에 구현하면 안 된다.
  - 억지로 구현하면 애그리거트는 자신의 책임 범위를 넘어서는 기능을 구현하기 때문에 코드가 길어지고 외부에 대한 의존이 높아지게 되며 코드를 복잡하게 만들어 수정을 어렵게 만드는 요인이 된다.
  - 게다가 애그리거트의 범위를 넘어서는 도메인 개념이 애그리거트에 숨어들어 명시적으로 드러나지 않게 된다.
- 이런 문제를 해소하기 위해 도메인 기능을 별도 서비스로 구현하는 방식을 사용할 수 있다.

----

## 2. 도메인 서비스

- 주로 다음 상황에서 도메인 서비스를 사용한다.
1. 계산 로직: 여러 애그리거트가 필요한 계산 로직이나, 한 애그리거트에 넣기에는 다소 복잡한 계산 로직
2. 외부 시스템 연동이 필요한 도메인 로직: 구현하기 위해 타 시스템을 사용해야 하는 도메인 로직

### 2-1. 계산 로직과 도메인 서비스

- 도메인 서비스를 통해 도메인 개념을 명시적으로 드러낼 수 있다. 응용 영역의 서비스가 응용 로직을 다룬다면 도메인 서비스는 도메인 로직을 다룬다.
- 애그리거트나 밸류와 같은 구성요소와 도메인 서비스를 비교할 때 다른 점은 도메인 서비스는 상태 없이 로직만 구현한다는 점이다.
  - 도메인 서비스를 구현하는 데 필요한 상태는 다른 방법으로 전달받는다.
- 애그리거트 객체에 도메인 서비스를 전달하는 것은 응용 서비스 책임이다.

```java
public class Order {
  
  public void calculateAmounts(
      DiscountCalculationService disCalSvc, memberGrade grade) {
    Money totalAmounts = getTotalAmounts();
    Money discountAmounts =
        disCalSvc.calculateDiscountAmounts(this.orderLines, this.coupons, grade);
    this.paymentAmounts = totalAmounts.minus(discountAmounts);
  }
}
```

> #### 도메인 서비스 객체를 애그리거트에 주입하지 않기
> - 의존성 주입으로 처리하고 싶을 수 있지만, 저자는 좋은 방법이 아니라고 판단.
> - 도메인 객체는 필드로 구성된 데이터와 메소드를 이용해서 개념적으로 하나인 모델을 표현한다.
> - 모델의 데이터를 담는 필드는 모델에서 중요한 구성요소다. 그런데 데이터 자체와는 관련이 없고, DB 보관하는 저장 대상도 아닌 도메인 서비스를 주입? 굳이 할 필요가 없다.

> #### 특정 기능이 응용 서비스인지 도메인 서비스인지 감을 잡기 어려울 때
> - 해당 로직이 애그리거트의 상태를 변경하거나 애그리거트의 상태 값을 계산하는지 검사해 보면 된다.
> - 또한, 도메인 로직이지만 한 애그리거트에 넣기에 적합하지 않을 때 도메인 서비스로 구현하면 된다.

### 2-2. 외부 시스템 연동과 도메인 서비스

- 외부 시스템이나 타 도메인과의 연동 기능도 도메인 서비스가 될 수 있다.

### 2-3. 도메인 서비스의 패키지 위치

- 도메인 서비스는 도메인 로직을 표현하므로 도메인 서비스의 위치는 다른 도메인 구성요소와 동일한 패키지에 위치한다.
- 아니면 `domain` 패키지 밑에 `domain.model`, `domain.service`, `domain.repository`와 같이 하위 패키지를 구분하여 위치시켜도 된다.

### 2-4. 도메인 서비스의 인터페이스와 클래스

- 도메인 서비스의 로직이 고정되어 있지 않는 경우 도메인 서비스 자체를 인터페이스로 구현하고 이를 구현한 클래스를 둘 수도 있다.
- 특히 도메인 로직을 외부 시스템이나 별도 엔진을 이용해서 구현할 때 인터페이스와 클래스를 분리하게 된다.
- 도메인 서비스의 구현이 특정 구현 기술에 의존하거나 외부 시스템의 API를 실행한다면 도메인 영역의 도메인 서비스는 인터페이스로 추상화해야 한다.
  - 도메인 영역이 특정 구현에 종속되는 것을 방지

----

# 참고자료

- 도메인 주도 개발 시작하기, 최범균 지음
