# 04 검색

- 실제 데이터를 인출하기 위한 쿼리.
- 대량의 데이터를 대상으로 빠르고 정확한 검색이 가능하게 만들어 줌.

## 1. 쿼리 컨텍스트와 필터 컨텍스트

- `쿼리 컨텍스트 Query Context`: 질의에 대한 유사도를 계산해 이를 기준으로 더 정확한 결과를 먼저 보여준다.
- `필터 컨텍스트 Filter Context`: 유사도를 계산하지 않고 일치 여부에 따른 결과만을 반환한다.
- 과거 1.x 버전에서 `용어 검색 term query`과 `용어 필터 term filter`처럼 쿼리 컨텍스트와 필터 컨텍스트가 명확히 구분되었으나, 논리 쿼리가 나오면서 필터 컨텍스트는 모두 논리 쿼리에 포함되게 되었다.
  - 필터 컨텍스트 단독 사용보다는 쿼리/필터 컨텍스트를 조합해 사용하는 방향으로 가는 추세

## 2. 쿼리 스트링과 쿼리 DSL

- 쿼리 스트링은 한 줄 정도의 간단한 쿼리에 사용.
- 쿼리 DSL은 복잡한 쿼리를 작성할 때 사용. 엘라스틱서치에서 제공하는 쿼리 전용 언어. JSON 기반으로 직관적이다.

### 2-1. 쿼리 스트링

- `/_search?q={검색어}` 형태로 사용.
- REST API의 쿼리 스트링과 같다고 보면 된다.

### 2-2. 쿼리 DSL

- REST API의 RequestBody에 JSON 형태로 쿼리를 작성하는 방식.

```http request
GET kibana_sample_data_ecommerce/_search
{
  "query": {
    "match": {
      "customer_full_name": "Mary"
    }
  }
}
```

- 자동 완성도 지원되어 타이핑 실수도 줄일 수 있다.

## 3. 유사도 스코어

- 기본으로 BM25 알고리즘 사용
- 유사도 스코어는 질의문과 도큐먼트의 유사도를 표현하는 값.
  - 스코어가 높을수록 찾고자 하는 도큐먼트에 가깝다는 사실.
- 검색 시, RequestBody JSON에 `explain: true` 필드를 추가하여 쿼리 내부적인 최적화 방법과 어떤 경로를 통해 검색되었으며, 어떤 기준으로 스코어가 계산되었는지 확인 가능.

### 3-1. 스코어 알고리즘(BM25)

- 5.x 이전 버전에서는 TF-IDF 알고리즘을 사용했으나, 5.x부터 BM25이 기본 알고리즘으로 변경됨.
- BM25는 검색, 추천에 많이 사용되며, `TF(Term Frequency)`, `IDF(Inverse Document Frequency)` 개념에 문서 길이를 고려한 알고리즘.
- 검색어가 문서에서 얼마나 자주 나타나는지, 얼마나 중요한 용어인지.

### 3-2. IDF 계산

- `문서 빈도 Document frequency`는 특정 용어가 얼마나 자주 등작 했는지에 대한 지표. => 일반적으로 자주 등장하는 용어는 중요하지 않을 확률이 높다.
  - ex) 'to', 'the' 등
- 그래서 도큐먼트 내에서 발생 빈도가 적을수록 가중치를 높게 주는데 이를 `문서 빈도의 연수 Inverse Document Frequency, IDF`라고 한다.

```
"idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:",
```

- 요소의 의미
  - `n`은 용어가 몇 개의 도큐먼트에 있는지.
  - `N`은 인덱스의 전체 도큐먼트 수.

### 3-3. TF 계산

- 특정 용어가 도큐먼트에서 많이 반복되었다면 그 용어는 도큐먼트의 주제와 연관되어 있을 가능성이 높다.
- 하나의 도큐먼트에서 특정 용어가 많이 나오면 중요한 용어로 인식하고 가중치를 높인다.

```
"tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:"
```

- 요소의 의미
  - `freq`: 도큐먼트에서 용어가 나온 횟수
  - `k1`, `b`: 알고리즘을 정규화하기 위한 가중치. 엘라스틱서치가 디폴트로 취하는 상수.
  - `dl`: 필드 길이
  - `avgdl`: 전체 도큐먼트에서 평균 필드 길이.
- `dl`이 작고 `avgdl`이 클수록 TF 값이 크게 나온다.

- 최종 스코어 계산식은 아래와 같다.

```
"description": "score(freq=1.0), computed as boost * idf * tf from:",
"details": [
  {
    "value": 2.2,
    "description": "boost",
    "details": []
  },
  ...
]
```

- 최종 스코어는 `IDF`와 `TF` 그리고 `boost` 변수를 곱하면 된다.
  - `boost`는 엘라스틱이 지정한 고정값으로 2.2로 정해져 있다.

---

# 참고 자료

- 엘라스틱 스택 개발부터 운영까지, 김준영 & 정상운 지음, 박재호 감수, 펴낸곳: 책만
