# Chapter01. 관측 가능성의 개념과 방향성

## 3가지 요소

### 1. 모니터링과 차이점

> #### 관측 가능성 observability
> - '시스템에서 외부로 출력되는 값만을 사용해서, 시스템의 내부 상태를 이해하고 예측하는 것'

- 모니터링은 블랙박스 영역과 화이트박스 영역을
    - 블랙박스 모니터링이 제공하는 정보는 상세하지 못하므로 상세한 디버깅 정보로 활용하기 어렵다.
- 관측 가능성은 화이트박스 영역과 예측 영역을 담당
    - 애플리케이션 내부의 상태를 디버깅할 수 있는 정보 제공 => 장애 발생했을 때 신속하고 수월하게 대응
    - 원하는 계측을 추가
- 관측 가능성에서의 용어
    - APM 대신 `추적 tracing`
    - `계측 instrumentation`과 `텔레메트리 telemetry`를 범용적 사용

### 2. 관측 가능성 구성 요소

#### 메트릭

- 일정 시간 동안 측정된 데이터를 집계하고 이를 수치화
    - ex) `대기 pending` 메시지 개수, 사용 중인 CPU와 메모리의 크기, 서비스에서 초당 처리하는 개수 등
- 전체적인 시스템의 상태를 보고하는 데 특히 유용

#### 로그

- 애플리케이션 실행 시 생성되는 텍스트 라인

#### 추적 tracing

- 마이크로서비스가 시스템을 경유하며 `트랜잭션`을 처리하는 과정에서 발생하는 세부적인 정보를 보여준다.
    - 트랜잭션이 시스템을 이동하는 경로, 트랜잭션을 처리하는 과정에서 발생하는 대기시간과 지연시간, 병목 현상이나 에러를 일으키는 원인을 `문맥 context`과 로그, 태그 등의 `메타데이터 metadata`에 출력한다.
- 오픈트레이싱과 오픈텔레메트리와 같은 다양한 계측과 추적을 위한 표준 제정

---

## 메트릭

### 1. 가용성

- 가용성을 측정하는 주요 관찰 수단
- `SLI, Service level indicator`를 측정하는 지표
    - `SLO, Service level objective`라고 불리는 임계 기준을 달성해야 하며, SLO는 SLI의 상한과 하한 범위를 지정
    - `SLA, Service level agreement`에 명시된 제공 수준보다 제한적이거나 보수적인 추정치

### 2. 구글의 골든 시그널

- 주요 SLO 지표는 가용성 외에도 지연과 에러가 있음. 이는 구글 SRE에서 제시하는 지표와 중복
- 4가지 골든 시그널

#### (1) 지연 latency

- 지연과 에러를 구분해야 한다.
- 에러는 지연 없이 빠르게 처리되는 경향이 있고, 정상 응답은 지연을 포함하는 경우가 많다.
- 지연 시간에 대한 기준. SLI를 명확하게 정의해야 하는 이유

#### (2) 에러 error

- 에러 기준도 중요.
- 에러에 담긴 다양한 정보
    - 추적 ID
    - 다양한 유형: 이상 탐지, 인프라, 애플리케이션
    - 세 가지 상태: `정상 normal` - `에러의 처음 발견, pending` - `에러가 계속 활성 상태를 유지할 경우 firing`
- SLO 지표는 멀티 우도와 멀티 레이트를 지원해야 하므로 복잡하다.

#### (3) 트래픽 traffic

- 요청의 양: 관찰되는 시스템의 유형, 초당 요청의 수, 네트워크 입출력 등 다양
- 양이 적을 때는 문제가 없다. 임계치를 초과하거나 포화 강태가 되면 지연과 에러가 발생. 최종적으로 장애에 이른다.
- 지연과 에러가 발생하더라도 중단 없이 적정 수준의 트래픽을 처리할 수 있는 시스템을 구축하는 것이 클라우드 네이티브의 사상

#### (4) 포화 saturation

- 리소스가 '현재 얼마나 채워졌는지'와 '얼마나 가득 채울 수 있는지'를 나타내는 것
    - 전체 총대역폭과 처리 가능한 트랙픽에 대비해서 현재 트랙픽 혹은 대역폭이 어느 정도인지 이해할 수 있는 지표인 셈
    - 포화를 통해 향후 트래픽이 증가했을 경우에 이용 가능한 자원 총 사용률을 예측할 수 있다.
    - CPU, 메모리, 네트워크와 같이 제약이 큰 리소스에 적용
- 지연 증가는 종종 포화의 선행 지표
- 동적인 트래픽에 맞춰 스케일하는 방법을 제공하는 것이 적합
- 신호가 에러, 지연, 정상, 오류인지 정의하는 작업이 필요

### 3. 메트릭 유형

- 모니터링하려고 하는 리소스에 가장 적절한 유형을 결정해야 한다.
- 일반적으로 4가지 유형이 있다.

#### (1) 카운터 counter

- 모니터링하는 이벤트의 누적 개수 혹은 크기
- ex) 초당 요청 개수, 초당 처리 개수

#### (2) 게이지 gauge

- 증가하거나 감소하는 임의의 값
- '현재 상태'를 표현하는 메트릭 타입
- ex) 데이터베이스에 연결된 커넥션 개수, 현재 동작하는 스레드 개수, 사용률

#### (3) 요약 summary

- `응답의 크기 response size`와 대기시간을 추적하는 데에도 사용
- 측정한 이벤트의 합계와 카운트를 모두 제공
- 범위와 분포에 관계없이 정확한 백분위수가 필요하다면 사용

#### (4) 히스토그램 histogram

- 시간 경과에 따른 추세와 데이터가 단일 범주에서 어떻게 분포되어 있는지
    - 주로 `분위수 quantile`를 사용 => 오름차순(혹은 내림차순)으로 정렬되어 있는 전체 자료를 특정 개수로 나눌 때 그 기준이 되는 수

#### 4. 시계열 데이터

- 차트로 표현하고 시각화
- 히스토그램: 정해진 시간 내의 분포와 변화를 출력하기 위해서 적합한 차트 형식
- `로키 Loki`는 특정 시간 동안의 분포를 이해할 수 있으며 추적의 간트 화면으로 전환
- 상관관계를 효과적으로 활용하면 복잡한 문제를 신속하게 해결할 수 있다.

#### 5. 프로메테우스의 히스토그램

- 히스토그램에서의 버킷은 특정 범위를 의미
    - 특정 버킷에 속하는 측정값의 개수(빈도)를 계산할 수 있다.
- 히스토그램 내부 구조
    - 버킷당 1개의 시계열 생성, 관측한 회수와 관측한 값의 합계에 대한 2개의 시계열을 추가로 생성.
    - 관측 결과를 샘플링
    - 각 버킷마다 이전 버킷의 값에 현재 버킷의 값을 추가하는 형태로 누적
    - x축은 시간 / y축은 요청 지속 기간, 응답 크기 등
    - 단점: 선택한 버킷이 수집될 것으로 예상되는 값의 범위와 분포에 적합해야 한다는 것
- 요약과 히스토글매의 차이점?
    - 요약은 클라이언트 측에서 계산하고 분위수당 시계열을 생성함
    - 히스토그램의 분위수는 서버에서 계산하고 버킷당 시계열을 생성

#### 6. 메트릭 관리 방안

- 메트릭은 단순 집계 모니터링에 그치지 않고 오토스케일링 등 다양한 분야와 연계
    - 만약 기본 메트릭으로 부족하다면 커스텀 메트릭 개발 필요
- 중요 포인트!!
    - 너무 많은 정보가 있으면 추론이 어렵다!
    - 상관관계를 가지는 차트를 대시보드에 구성하자!
    - 도메인/서비스의 흐름대로 차트를 구성하는 것을 추천한다!
- 가장 중요한 정보를 표시하는 상위 수준의 대시보드는 1개만 유지!
- 메트릭을 표시할 때 응답시간, 에러, 트래픽 같은 가장 중요한 것에 집중! => 관측 역량의 토대
- 가능하면 태그를 사용해 메트릭에 상황 정보를 포함
- 메트릭의 이름을 지을 때 정의된 표준을 지키자!

