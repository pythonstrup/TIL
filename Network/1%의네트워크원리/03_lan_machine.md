# Chapter 03 케이블의 앞은 LAN 기기였다.

#### 부제: 허브와 스위치, 라우터의 탐험

- 클라이언트 PC는 가정이나 회사의 LAN을 경유하거나 단독으로 인터넷에 접속할 수 있다.
  - 클라이언트 PC가 가정이나 회사의 LAN에 접속하고 앞부분이 ADSL이나 광섬유(FTTH) 등의 광대역 회선에 의해 인터넷에 접속된다는 최신의 대표적인 상황을 가정하여 탐험한다.
  - 이 경우 LAN 어댑터가 송신한 패킷은 스위칭 허브 등을 경유하여 인터넷 접속용 라우터에 도착한다.
  - 라우터의 앞부분은 이미 인터넷이므로 여기에서부터 앞부분은 통신사(프로바이더, provider)가 패킷을 상대에게 운반한다.

## 1. 케이블과 리피터, 허브 속을 신호가 흘러간다

### 1-1. 하나하나의 패킷이 독립된 것으로 동작한다.

- 컴퓨터에서 송신된 패킷은 허브나 라우터라는 중계 장치에 의해 중계되어 목적지를 향해 진행한다.
  - 패킷의 헤더에 기록된 제어 정보와 중계 장치의 내부에 있는 중계 대상을 등록한 표로 목적지를 판단하고 목적지에 가까워지도록 하여 패킷을 중계하는 형태다.
  - 중계 동작을 할 때 우편배달부가 편지의 내용을 보지 않고 배달하는 것처럼 중계 장치는 데이터 부분을 보지 않고 패킷을 중계한다.
- 내용을 보지 않으므로 거기에 쓰여있는 애플리케이션의 데이터나 TCP 프로토콜의 제어 정보의 내용이 패킷을 운반하는 동작에 영향을 주지 않는다.
  - 즉 HTTP의 메시지, TCP의 수신 확인이나 시퀀스 번호, 클라이언트와 서버라는 관계는 모두 무시된다.
  - 따라서 모든 패킷은 아무 관련도 없는 별개의 것으로 간주하고 목적지를 향해 중계된다.
- 클라이언트 PC가 LAN에 접속해 있는 것을 가정한다.
  - PC가 송신한 패킷이 리피터 허브, 스위칭 허브, 라우터를 경유하여 인터넷에 나가는 것으로 간주한다.
  - 가정에서는 리피터 허브나 스위칭 허브가 내장된 라우터를 사용하는 경우가 많고 단일 기능의 여러 기기를 연결해서 사용하는 경우가 적을 것이다.
  - 그러나 단일 기능의 기기가 이해하기 쉬우므로 단일 기능의 기기를 알면 여러 기능을 내장한 복합적인 기기도 이해할 수 있다.

<img src="img/lan01.jpg">

### 1-2. LAN 케이블은 신호를 약화시키지 않는 것이 핵심이다

- LAN 어댑터의 PHY(MAU) 회로에서 전기 신호로 형태를 바꾼 패킷은 RJ-45 커넥터를 통해 `트위스트 페어 케이블(꼰 선쌍)`에 들어가는데, 이 부분을 확대한 것이 아래 그림이다.
  - 이더넷의 신호의 실체는 플러스와 마이너스의 전압이므로 LAN 어댑터의 `PHY(MAU)` 회로의 플러스와 마이너스 신호 단자에서 신호가 나온다고 생각하면 된다.
  - LAN 어댑터의 `PHY(MAU)` 회로는 RJ-45 커넥터에 직접 결선되어 있으므로 커넥터의 1번 핀과 2번 핀에서 케이블로 신호가 흘러나간다.
  - 그 후 신호는 케이블 속을 흘러 리피터 허브의 커넥터 부분에 도착하고, 이 부분은 단순히 전기 신호가 케이블을 통해 전달되는 것이다.

<img src="img/lan02.jpg">

- 그림에 대한 설명
1. PHY(MAU)는 LAN 어댑터나 허브의 것과 기본적으로 같다.
2. 플러스와 마이너스의 한조로 신호 전달
3. LAN 어댑터 값은 직접 결선(MDI)
4. 신호선에는 색이 표시되어 있으며, EIA-568B라는 사양으로 다음과 같이 결선하도록 결정되어 있다.
    - 1 - 하양/주황
    - 2 - 주황
    - 3 - 하양/초록
    - 4 - 하양/파랑
    - 5 - 파랑
    - 6 - 초록
    - 7 - 하양/갈색
    - 8 - 갈색
5. 신호선은 2개가 1조로 꼬여있다.
6. 신호선의 배치는 양끝 모두 같다.
7. 컴퓨터를 접속하는 포트, 신호선을 교차시켜 결선(MDI-X)
8. 다른 허브와 접속하는 경우의 포트. '애플링크(AppleLink)용' 또는 '캐스케이드 접속용'이라고 한다. 이곳은 LAN 어댑터와 마찬가지로 MAU가 직접 접속되어 있다.(MDI) 이렇게 해서 다른 허브와 접속했을 때 양쪽의 송신과 수신이 연결된다.
9. 입력 신호를 수신 포트 이외의 모든 포트에 출력하는 것이 리피터 회로의 역할이다. 복수의 포트에서 동시에 신호가 들어오면 복수의 신호가 혼합된 신호를 모든 포트에 출력하기 때문에 패킷이 충돌하는 것이다.

<br/>

#### 송출한 신호는 그대로의 모습으로 허브에 도착하는 것이 아니라 허브에 도착할 때 신호가 약해져 있다.

- 케이블을 통과하는 사이에 신호의 에너지가 조금씩 떨어지므로 게이블의 길이가 길어질수록 신호가 약해진다.
- 신호는 단지 약해지기만 하는 것이 아니다.
  - 이더넷은 사각형의 각진 신호를 사용하지만 이 각이 뭉개져서 둥글게 된다.
  - 이 현상은 주파수가 높을수록 에너지가 떨어지는 비율이 높다는 전기 신호의 성질과 관계가 있다.
  - 신호의 각진 부분은 전압이 급격히 변화하는데, 이것은 해당 부분의 주파수가 높다는 의미다.
  - 주파수가 높은 신호는 약해지므로 급격한 변화가 없어져서 각이 뭉개지는 것이다.
- 잡음이 없고 조건이 좋은 경우에도 신호가 도착할 때는 이와 같이 변형되는데, 이것에 잡음의 영향까지 더해지면 매우 심각하게 변형된다.
  - 약해진 신호가 더욱 변형되므로 0과 1을 잘못 판독할 수 있는데, 이것이 통신 오류의 원인이 된다.

### 1-3. '꼼'은 잡음을 방지하기 위한 방법이다

- `트위스트 페어 케이블(꼰 선쌍)`에는 이러한 잡음의 영향을 억제하는 대책이 마련되어 있는데, 이것이 '꼼'이다.
  - 신호선을 마구 꼬아서 잡음을 막을 수 있다.
- 잡음이 생기는 원리 
  - 잡음의 원인은 케이블 주위에서 발생하는 전자파다.
  - 신호와 잡음의 전류가 뒤섞여서 신호의 파형이 변형되는데, 이것이 잡음의 정체다.
- 케이블에 영향을 주는 전자파는 두 종류로 나눌 수 있다.
  1. 모터, 형광등, CRT 모니터와 같은 기기에서 누설되는 전자파 => 선을 '꼼'으로써 막을 수 있다.
  2. 케이블 안의 인접한 신호선에서 누설되는 전자파. 이러한 잡음의 영향을 `크로스토크 crosstalk`라고 한다. => 이것을 막는 대책도 신호선을 마주 꼬는 것이다.
- 꼬는 간격을 미묘하게 변화시키면 어떤 부분에서는 플러스 신호가 가까이에 있고, 다른 부분에서는 마이너스 신호선이 가까워진다.
  - 그러면 플러스와 마이너스에서는 잡음의 영향이 반대가 되므로 플러스와 마이너스의 균형이 잡히면서 잡음의 영향이 줄어든다.
- 신호선을 마주 꼬면 케이블의 성능이 향상되지만 성능 향상의 대책이 이것만 있는 것은 아니다.
  - 금속성의 실드(`차폐, shield`)라는 피복을 입히는 등의 대책도 있다. 

### 1-4. 리피터 허브는 연결되어 있는 전체 케이블에 신호를 송신한다

- 신호가 리피터 허브에 도달하면 LAN 전체에 신호가 흩어진다.
  - 이더넷의 기본이라는 원리. 전체에 패킷의 신호를 뿌리고 수신처 MAC 주소에 해당하는 기기만 패킷을 수신한다는 원리를 그대로 실현한 것이 리피터 허브다.
- 리피터 허브의 내부
  - 각 커넥터의 안쪽에는 LAN 어댑터의 내부에 있는 PHY(MAU) 회로와 역할이 같은 회로가 있다.
  - LAN 어댑터측과 같이 RJ-45 커넥터에 직접 접속하면 신호를 제대로 수신할 수 없다.
  - 제대로 수신하려면 '송신 단자'에서 보낸 신호를 '수신 단자'로 받도록 해야 한다.
  - 허브 안의 PHY(MAU) 회로와 커넥터 사이의 신호선을 교차시켜서 접속하는 것이 이 때문이다. 한쪽의 송신이 상대의 수신에 연결되어 신호를 제대로 송/수신할 수 있게 된다.
- 리피터 허브에서 끝의 커넥터에는 `MDI/MDI-X`와 같이 쓰여있는 전환 스위치가 붙어있는데, 이를 통해 의미를 알 수 있을 것이다.
  - `MDI`는 RJ-45 커넥터와 신호 송/수신 회로를 직접 결선한 것이다.
  - `MDI-X`는 교차하여 결선하는 것을 나타낸다.
- 허브와 커넥터 부분은 보통 MDI-X이다.
  - 허브의 커넥터 부분은 보통 MDI-X이므로 허브끼리 접속할 때는 한쪽을 MDI로 설정해야 한다.
  - 만약 MDI로 전환하는 스위치가 없고 모든 커넥터가 MDI-X인 경우에는 `크로스 케이블`로 허브들을 접속한다.
  - 크로스 케이블은 송신과 수신 단자가 바뀌어 들어오도록 신호선을 접속한 케이블이다.
- 리퍼터 허브에서 `PHY(MAU)` 회로의 수신부에 도달한 신호는 여기부터 `리피터 회로`에 들어간다.
  - 리피터 회로의 기본은 들어오는 신호를 리피터 허브의 커넥터 부분에 뿌리는 데 있다.
  - 여기에서 신호의 파형을 다듬고 오류를 억제하도록 연구한 제품도 있지만, 기본은 들어온 신호를 그대로 커넥터 부분에 송출하는 것이다.
  - 따라서 잡음의 영향을 받아 변형되고, 데이터가 변화한 것 같은 신호라도 그대로 흘려버린다.

<br/>

## 2. 스위칭 허브의 패킷 중계 동작

### 2-1. 스위칭 허브는 주소 테이블로 중계한다

- 아래는 패킷이 스위칭 허브를 경우하여 흘러갈 때의 동작이다.
  - 스위칭 허브는 이더넷의 패킷을 그대로 목적지를 향해 중계하도록 만들어져 있다.
- 먼저 신호가 커넥터 부분에 도달하여 PHY(MAU) 회로에서 수신되는 부분까지는 리피터 허브와 동일하다.
  - 커넥터와 PHY(MAU) 회로는 MDI-X로 접속되어 있고, 트위스트 페어 케이블에서 신호가 들어오면 이것이 PHY(MAU) 회로의 수신 부분에 들어간다.
- PHY(MAU) 회로에서 케이블을 흐르는 신호의 형식부터 공통의 신호 형식으로 변환한 후 신호는 MAC 회로로 들어간다.
  - 여기에서 디지털 데이터로 변환한 후 패킷의 맨 끝에 있는 FCS를 대조하여 오류의 유무를 검사하고, 문제가 없으면 버퍼 메모리에 저장한다.
  - 이 부분은 LAN 어댑터와 거의 같으므로 각 스위칭 허브의 커넥터 안쪽에는 LAN 어댑터와 같은 회로가 있다고 생각하면 좋을 것이다.
- 커넥터 안쪽에 있는 회로 부분을 `포트`라고 부르므로 스위칭 허브의 각 포트는 PC의 LAN 어댁터와 거의 같습니다.
  - 그러나 LAN 어댑터와 다른 부분이 있다. LAN 어댑터에는 MAC 주소가 할당되어 있어서 수신한 패킷의 수신처 MAC 주소가 자신에게 해당하지 않는 경우에는 패킷을 폐기한다.
  - 반면 스위칭 허브의 포트는 수신처 MAC 주소를 검사하지 않고 모든 패킷을 수신하여 버퍼 메모리에 저장하기 때문에 스위칭 허브의 포트에는 LAN 어댑터와 달리 MAC 주소가 할당되어 있지 않다.
- 패킷을 버퍼 메모리에 저장하면 다음에 수신처 MAC 주소와 일치하는 것이 MAC 주소표에 등록되어 있는지 조사한다.
  - MAC 주소표에는 기기의 MAC 주소와 그 기기가 어느 포트에 존재하는지에 대한 정보가 등록되어 있다. 아래 주소표와 같이 MAC 주소와 포트가 짝을 이루고 있다.
  - 이것을 사용하여 수신한 패킷을 어느 포트에서 송신하면 좋을지를 판단한다. 예를 들어 수신한 패킷의 수신처 MAC 주소가 '00-02-B3-1C-9C-F9'라면 표의 세 번째 행에 등록된 주소와 일치하므로 포트 항목에 쓰여있듯이 주소는 9번 포트에 있다는 것을 알 수 있다.
  - 이 사실을 알았다면 `스위치 회로`를 경유하여 패킷을 송신측의 포트에 보냈는데, 이 예의 경우 8번 포트가 송신측 포트가 된다.

<img src="img/lan03.jpg">

#### 그림에 대한 설명1 - MAC 주소표

- 스위치의 내부에는 MAC 주소와 포트 번호를 등록한 테이블이 있다.
- 여기에는 패킷을 수신할 때 수신 포트와 송신처 주소가 함께 등록된다.
- 이를 통해 이 주소가 어느 포트에 접속되어 있는지 판단할 수 있다. 패킷을 중계할 때는 이 정보로부터 어디에 패킷을 송신해야 할지 판단한다.

|      MAC 주소       | 포트  | 제어 정보 |
|:-----------------:|:---:|:-----:|
| 00-60-97-A5-43-3C |  2  |  ...  |
| 00-00-C0-16-AE-FD |  7  |  ...  |
| 00-02-B3-1C-9C-F9 |  8  |  ...  |
|        ...        | ... |  ...  |

#### 그림에 대한 설명2 - 번호에 대한 설명

1. 동작 원리에서 보면 스위칭 허브의 포트는 LAN 어댑터와 거의 비슷한다. 실제로는 이 그림과 같이 각 포트마다 별도로 MAU, LANC, 메모리가 존재하는 것이 아니라 복수의 포트를 동시에 제어하는 스위치로 구성된 것이 일반적이다.
2. 패킷을 중계하는 핵심 부분이다. 이 부분의 구성은 제품에 따라 다르며 스위치 회로가 아니라 고속 신호선(버스)으로 구성한 것, 공유 메모리로 구성한 것 등이 있다.
3. 복수의 패킷 중계 동작을 동시에 실행할 수 있다.

<br/>

#### 스위치 회로의 구조

- 스위치 회로는 전자 회로로 만든 것으로, 이를 통해 입력 포트와 출력 포트를 연결할 수 있다.
  - 여기에는 신호선이 격자 모양으로 배치되고, 교점에 스위치가 있다.
  - 이 스위치는 전자적으로 개폐를 제어할 수 있고, 이 전자적 개폐를 통해 신호가 흐르는 대상을 제어한다.
  - 입력측은 수신측 포트에, 출력측은 송신측 포트에 각각 접속되어 있다.
- 포트 사이에 패킷을 운반할 때는 이 회로의 패킷의 신호를 흘린다.
  - 예를 들어 2번 포트에서 7번 포트로 패킷을 운반하려면 신호는 입력측의 2번에서 들어올 것이다.
  - 이때 이 선의 가로로 나열된 스위치의 왼쪽에서 6개까지의 스위치는 가로 방향으로, 일곱 번째의 스위치는 세로 방향으로 전환한다.
  - 그러면 신호는 출력측의 7번으로 흘러가고, 그 앞의 7번 포트에 패킷이 도착한다. 신호의 교점에 있는 스위치는 각각 독립하여 움직이므로 신호가 중복되지 않으면 복수의 신호를 동시에 흘릴 수도 있다.
- 이 스위치 회로를 경유하여 송신측의 포트에 패킷을 운반하면 MAC 회로나 PHY(MAU) 회로가 송신 동작을 실행하고 케이블에 신호가 흘러간다.
  - 이때 송신 동작도 LAN 어댑터의 송신 동작과 같다. 이더넷의 규칙에 따라 먼저 아무도 송신중이지 않다는 것을 확인한다.
  - 즉 신호 송/수신 회로의 수신 부분에 신호가 흘러들어오지 않는 것을 확인한다. 누군가가 송신 중이면 그것이 끝날 때까지 기다린다. 그리고 송신 동작이 끝나거나 아무도 송신하지 않으면 소켓을 디지털 데이터에서 신호로 변환하여 송신한다.
  - 송신 동작을 하고 있는 사이에 수신 신호를 감시하는 부분도 LAN 어댑터와 같다. 송신 동작 중에 다른 기기가 보낸 신호가 수신측에 들어오면 패킷이 충돌하므로 `재밍 신호`를 보낸 후 송신 동작을 중지하고 잠시 기다렸다가 다시 보내는데, 이것도 LAN 어댑터와 같다.

### 2-2. MAC 주소 테이블을 등록 및 갱신한다

- 스위칭 허브는 패킷을 중계할 때 MAC 주소표의 내용을 갱신하는 동작도 실행한다. 갱신의 동작은 두 종류가 있다.
  1. 패킷을 수신했을 때 송신처 MAC 주소를 조사하고, 이것을 수신한 입력 포트 번호와 하나의 세트로 MAC 주소표에 등록하는 것이다.
  2. 일정 시간이 경과하면 MAC 주소표에 등록된 정보를 삭제한다.
- MAC 주소표의 내용은 스위칭 허브 자체가 스스로 등록하거나 삭제하므로 수동으로 등록 및 삭제할 필요가 없다.
  - MAC 주소표의 내용이 이상해진 경우에도 기기를 리셋하여 MAC 주소표의 내용을 전부 지워버리면 이때부터 새롭게 주소가 등록되므로 수동 갱신할 필요가 없다.

### 2-3. 예외적인 동작

#### 포트 번호가 같은 경우

- 스위칭 허브는 패킷을 수신한 포트와 송신하는 포트가 같을 경우 패킷을 중계하지 않고 폐기한다.

#### 일치하는 MAC 주소가 없을 경우

- MAC 주소표와 수신처 MAC 주소와 일치하는 주소가 등록되어 있지 않은 경우도 있다.
  1. 주소의 기기에서 패킷이 한 번도 스위칭 허브에 도착하지 않은 경우
  2. 시간이 경과하여 MAC 주소표에서 삭제된 경우
- 패킷을 수신한 포트 이외의 전체 포트에서 패킷을 송신한다. 수신처 MAC 주소의 기기는 어딘가에 존재할 것이므로 이 방법을 통해 패킷이 도착한다.
  - 기기가 존재하지 않는 포트에도 송신되지만 이 때문에 문제가 생기지는 않는다. => 무시되기 때문에
  - 패킷을 보내면 무언가의 응답이 돌아오고 그 때 주소표에 등록되므로 두 번째 이후는 네트워크 전체에 패킷을 보내지 않게 된다.
- LAN에는 1초에 수천 개 이상의 패킷을 흘려보내는 능력이 있으므로 패킷이 한두 개 증가해도 큰 문제가 되지 않는다.
- 또한 수신처의 MAC 주소가 `브로드캐스트 주소`인 경우에도 수신 포트를 제외하고 모든 포트에서 패킷을 송신한다.

> #### 브로드캐스트 주소
> - 주소를 수신처 주소로 지정하여 패킷을 보내면 네트워크에 접속된 모든 기기에 패킷이 도착한다는 특별한 주소다.
> - LAN에 사용하는 MAC 주소는 FF:FF:FF:FF:FF:FF가 되고 IP 주소는 255.255.255.255가 브로드캐스트 주소가 된다.

### 2-4. 전이중 모드에서 송신과 수신을 동시에 실행한다.

- `전이중 모드` 즉 송신과 수신을 동시에 실행할 수 있는 성질도 리피터 허브에 없는 스위칭 허브의 특징이다.
  - 리피터 허브의 경우 여러 대의 컴퓨터가 동시에 송신 동작을 개시하면 리피터 허브의 내부에서 신호가 뒤섞여서 신호가 파괴된다.
- 리피터 허브를 사용하면 PHY(MAU)에서 충돌 검사를 하기 때문에 신호가 충돌하지 않는 셈이 된다.
- 충돌이 일어나지 않으면 반이중 모드의 충돌 방지 대책을 마련할 필요가 없다.
  - 즉 송신과 수신을 동시에 실행해도 상관없다.
  - 그러나 이더넷에 신호가 흐르고 있을 때는 이것이 끝나기를 기다렸다가 송신 동작을 실행하므로 그대로는 송신과 수신을 동시에 실행할 수 없다.
  - 그래서 이더넷의 규칙을 개정하여 신호가 흐르고 있어도 상관하지 않고 송신해도 좋다는 동작 모드를 새로 추가했다.
  - 동시에 이 동작 모드로 동작할 때는 신호의 충돌을 검출하는 회로를 무효롸하기로 했는데 이것이 '전이중'이라는 동작 모드이다.
- 전이중 모드는 송신할 때 신호가 흐르고 있어도 이것이 끝나기를 기다릴 필요가 없으므로 그만큼 반이중 모드보다 빠르게 동작한다.
  - 양방향으로 동시에 송신할 수 있으므로 송신할 수 있는 데이터 양의 상한선도 높아서 성능이 좋다.

### 2-5. 최적의 전송 속도로 보내는 자동 조정

- 전이중 모드와 반이중 모드를 전환할 필요가 생겼다.
  - 전이중 모드가 등장한 후 한동안 수동으로 동작 모드를 전환했지만 불편하므로 나중에 동작 모드를 자동으로 전환하는 기능이 나왔다.
  - 접속한 상대가 전이중 모드를 지원하는지 검출하고 동작 모드를 자동으로 전환하는 기능이다.
  - 이 기능을 `자동 조정 auto negotiation`이라고 한다.
- 이더넷은 데이터가 흐르고 있지 않을 때는 `링크 펄스`라는 펄스형의 신호를 흘린다.
  - 올바르게 동작하는지, 케이블이 단선되지 않았는지 등의 사항 확인
- 두 기기의 전원을 켜고 하드웨어의 초기화 동작이 끝나면 자체에서 지원하는 속도와 동작 모드를 펄스 신호로 보내기 시작한다.
  - 그러면 신호가 상대에게 도착하며, 도착한 펄스의 패턴을 읽고 상대가 어느 모드를 지원하는지 조사한다.
  - 모드에는 우선 순위가 결정되어 있고 우선 순위가 높은 것부터 차례대로 조사하면서 자신과 상대 모두가 지원하는 것을 찾는다.

### 2-6. 스위칭 허브는 복수의 중계 동작을 동시에 실행한다

- 스위칭 허브는 수신처 MAC 주소의 기기가 존재하는 포트 이외에는 송신 동작을 실행하지 않으므로 다른 포트는 빈 상태가 된다.
  - 여기에서 별도의 패킷을 흘릴 수 있으며, 이렇게 해서 동시에 여러 개의 패킷을 중계할 수 있다.
- 리피터 허브 쪽은 들어온 신호를 모든 포트에서 뿌리므로 동시에 두 개 이상의 신호가 들어오면 패킷이 충돌하기 때문에 복수의 신호를 동시에 흘릴 수 없다.
- 따라서 기기 전체에서 중계할 수 있는 패킷의 수는 스위칭 허브쪽이 리피터 허브쪽보다 많다.

<br/>

# 참고자료

- 성공과 실패를 결정하는 1%의 네트워크 원리, Tsutomu Tone 지음
